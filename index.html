<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart TV Live App</title>
  <link rel="preload" href="https://i.postimg.cc/yW4t2K7P/file-0000000095f461f68b9b01fc40148050-1.png" as="image">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      height: 100vh;
      background: black;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      position: relative;
    }
    #container {
      position: relative;
      height: 100vh;
      width: 100vw;
      background: transparent;
      display: none;
    }
    .channel-list {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      height: 100%;
      background: rgba(0,0,0,.85);
      display: none;
      flex-direction: column;
      padding: 0;
      overflow-y: auto;
      z-index: 100;
    }
    #incompatibleBox {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: rgba(0,0,0,.85);
      border: 3px solid #fff;
      border-radius: 12px;
      padding: 30px 40px;
      color: #fff;
      font-size: 22px;
      text-align: center;
      max-width: 90vw;
      z-index: 9999;
      display: none;
    }
    .channel {
      padding: 10px;
      border: 1px solid gray;
      margin-bottom: 5px;
      background: #222;
      cursor: pointer;
    }
    .channel.active {
      background: #444;
      border-color: #fff;
    }
    video {
      width: 100vw;
      height: 100vh;
      background: transparent;
      z-index: 1;
      object-fit: fill;
    }
    #playButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,.15);
      border: 2px solid #fff;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      will-change: transform,opacity;
      transition: opacity 0.5s ease;
    }
    #playButton.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    #playButton::before {
      content: '';
      display: block;
      width: 0;
      height: 0;
      border-left: 25px solid #fff;
      border-top: 15px solid transparent;
      border-bottom: 15px solid transparent;
      margin-left: 5px;
    }
    #playButton.playing::before {
      content: '';
      display: block;
      width: 25px;
      height: 30px;
      background: none;
      border-left: 10px solid #fff;
      border-right: 10px solid #fff;
      border-top: none;
      border-bottom: none;
      margin-left: 0;
    }
    #channelNumberOverlay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,.7);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 32px;
      font-weight: 700;
      z-index: 20;
      pointer-events: none;
      opacity: 0;
      color: #fff;
      transition: opacity .4s ease;
      will-change: opacity;
    }
    #azinLogo {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 70px;
      height: auto;
      z-index: 0;
      opacity: 0.7;
      filter: drop-shadow(0 1.5px 3px rgba(0,0,0,0.25));
      transition: opacity 0.3s ease;
      cursor: default;
      user-select: none;
      display: none;
    }
    #errorBox {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: #000;
      color: #fff;
      padding: 40px 60px;
      font-size: 28px;
      border: 4px solid #fff;
      border-radius: 16px;
      z-index: 100;
      display: none;
      text-align: center;
      box-sizing: border-box;
      min-width: 360px;
      max-width: 95vw;
      will-change: transform,opacity;
    }
    #networkErrorBox {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: #000;
      color: #fff;
      padding: 40px 60px;
      font-size: 28px;
      border: 4px solid #fff;
      border-radius: 16px;
      z-index: 100;
      display: none;
      text-align: center;
      box-sizing: border-box;
      min-width: 360px;
      max-width: 95vw;
      will-change: transform,opacity;
    }
    #staticNoise {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExOGw0bWJrMDQ0a2wzcXU0eWtsem1hOHhkZW11bmFlOTVrY3ZpZjFiZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Y8a0CT2xsbo9G/giphy.gif') center/cover no-repeat;
      opacity: 0;
      z-index: 6;
      transition: opacity .5s ease;
      pointer-events: none;
      display: none;
      will-change: opacity;
    }
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 1s ease;
    }
    #loadingScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .logo-container {
      position: relative;
      width: 450px;
      height: auto;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
      transform: scale(0.95);
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .logo-container img {
      width: 100%;
      height: auto;
      display: block;
      position: relative;
      z-index: 10;
      opacity: 10;
    }
    .light-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      height: 500px;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top: 4px solid #ff6600;
      border-right: 4px solid rgba(255, 102, 0, 0.3);
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
      animation: spin 6s linear infinite;
      z-index: 6;
      will-change: transform;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .particle {
      position: absolute;
      width: 5px;
      height: 5px;
      background: #ffaa00;
      border-radius: 50%;
      animation: floatUp 4s infinite ease-in-out;
      opacity: 0.8;
      z-index: 3;
    }
    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 0.1;
      }
      50% {
        transform: translateY(-40px) scale(1.3);
        opacity: 1;
      }
      100% {
        transform: translateY(-80px) scale(0.8);
        opacity: 0;
      }
    }
    .title {
      position: absolute;
      bottom: 50px;
      font-size: 2.2rem;
      color: #ffffff;
      letter-spacing: 4px;
      animation: fadeIn 1s ease forwards;
      opacity: 0;
      z-index: 2;
    }
    #offlineMessage {
      display: none;
      color: #fff;
      font-size: 1.5rem;
      position: absolute;
      bottom: 20px;
      text-align: center;
      width: 100%;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 2;
    }
    #offlineMessage.visible {
      display: block;
      opacity: 1;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }
    #greetingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      transition: opacity 1s ease;
    }
    #greetingScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #greetingScreen.visible {
      opacity: 1;
    }
    #greetingText {
      font-size: 48px;
      font-weight: 700;
      color: #fff;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      width: 0;
      max-width: 90%;
      display: inline-block;
      animation: typing 4s steps(33, end) forwards;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    video::-webkit-media-controls,video::-webkit-media-controls-panel,video::-webkit-media-controls-play-button {
      display: none !important;
    }
    .cast-button,#cast-button,google-cast-button,.google-cast-button,.cast-icon,.cast-context,.castSender,.cast-receiver,[is="google-cast-button"],[class*="cast"],[id*="cast"] {
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
    }
    .loader-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      z-index: 1000;
    }
    .dot-loader {
      display: flex;
      gap: 20px;
    }
    .dot-loader div {
      width: 30px;
      height: 30px;
      background-color: #FF6200;
      border-radius: 50%;
      animation: blink 1.2s infinite ease-in-out;
    }
    .dot-loader div:nth-child(2) {
      animation-delay: 0.2s;
    }
    .dot-loader div:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% {
        opacity: 0.2;
        transform: scale(0.45);
      }
      40% {
        opacity: 1;
        transform: scale(1.2);
      }
    }
    #qualitySelector {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      border-radius: 5px;
      z-index: 100;
      display: none;
    }
    #qualitySelect {
      background: transparent;
      color: #fff;
      border: 1px solid #fff;
      padding: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #qualitySelect option {
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="logo-container">
      <div class="light-ring"></div>
      <img id="loadingLogo" src="https://i.postimg.cc/yW4t2K7P/file-0000000095f461f68b9b01fc40148050-1.png" alt="">
    </div>
    <div class="title"></div>
    <div id="networkErrorBox">Please check your internet connection and try again.</div>
  </div>
  <div id="greetingScreen" class="hidden">
    <div id="greetingText"></div>
  </div>
  <div id="container">
    <div class="channel-list" id="channelList">
      <h2 style="margin:0 0 10px;padding:10px;font-size:20px;text-align:center;border-bottom:1px solid gray">Channels</h2>
    </div>
    <div id="staticNoise"></div>
    <div class="loader-container" id="channelLoader">
      <div class="dot-loader">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <div></div>
    </div>
    <audio id="noiseSound" src="https://cdn.pixabay.com/audio/2025/04/06/audio_513747fd8d.mp3" preload="auto" loop></audio>
    <audio id="typingSound" src="https://assets.mixkit.co/active_storage/sfx/1392/1392-preview.mp3" preload="auto"></audio>
    <video id="player" playsinline controlslist="nodownload noplaybackrate" disablePictureInPicture></video>
    <div id="qualitySelector">
      <select id="qualitySelect">
        <option value="auto">Auto</option>
      </select>
    </div>
    <div id="playButton" tabindex="0"></div>
    <div id="channelNumberOverlay"></div>
    <div id="errorBox">This channel is not available for now</div>
  </div>
  <img id="azinLogo" src="https://i.postimg.cc/65q6CC2P/file-00000000201c61f6b67764f95c3588ed.png" alt="Azin TV Logo">
  <div id="incompatibleBox">Sorry, only Android TVs are supported for this app</div>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.7/shaka-player.compiled.min.js"></script>
  <script>
    console.log("App initialization started at", new Date().toLocaleString());
    const channels = [
      {name: "Channel 1 - BTV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1709/output/1709-audio_113392_eng=113200-video=1692000.m3u8"},
      {name: "Channel 2 - NTV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1716/output/index.m3u8"},
      {name: "Channel 3 - Channel I", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1723/output/index.m3u8"},
      {name: "Channel 4 - Ekattor TV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1705/output/1705-audio_113352_eng=113200-video=1692000.m3u8"},
      {name: "Channel 5 - Independent TV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1704/output/master.m3u8"},
      {name: "Channel 6 - Banga Vision", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1715/output/index.m3u8"},
      {name: "Channel 7 - Somoy TV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1702/output/1702-audio_113322_eng=113200-video=1692000.m3u8"},
      {name: "Channel 8 - Jamuna TV", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1701/output/1701-audio_113312_eng=113200-video=1692000.m3u8"},
      {name: "Channel 9 - Channel 24", url: "https://d1e7rcqq4o2ma.cloudfront.net/bpk-tv/1703/output/1703-audio_113332_eng=113200-video=1692000.m3u8"},
      {name: "Channel 10 - Ekushey ETV", url: "http://210.4.72.204/hls-live/livepkgr/_definst_/liveevent/livestream3.m3u8"},
      {name: "Channel 11 - Massranga TV", url: "https://pubads.g.doubleclick.net/ssai/event/jirIBSMoQDWBeTr-f6WNpA/master.m3u8"},
      {name: "Channel 12 - Bangla Waz", url: "https://live20.bozztv.com/giatvplayout7/giatv-209617/tracks-v1a1/mono.ts.m3u8"},
      {name: "Channel 13 - Peace TV Bangla", url: "https://dzkyvlfyge.erbvr.com/PeaceTvBangla/index.m3u8"},
      {name: "Channel 14 - Al Istiqima", url: "http://jmc-live.ercdn.net/alistiqama/alistiqama_576p.m3u8"},
      {name: "Channel 15 - Iqra TV", url: "https://ap02.iqplay.tv:8082/iqb8002/iq53la/playlist.m3u8"},
      {name: "Channel 16 - Gopa Bhar Live", url: "https://live20.bozztv.com/giatvplayout7/giatv-209611/tracks-v1a1/mono.ts.m3u8"},
      {name: "Channel 17 - PBS Kids", url: "https://2-fss-2.streamhoster.com/pl_140/amlst:200914-1298290/playlist.m3u8"},
      {name: "Channel 18 - TV9 Bangla", url: "https://dyjmyiv3bp2ez.cloudfront.net/pub-iotv9banaen8yq/liveabr/playlist.m3u8"},
      {name: "Channel 19 - FIFA+", url: "https://a62dad94.wurl.com/master/f36d25e7e52f1ba8d7e56eb859c636563214f541/UmFrdXRlblRWLWV1X0ZJRkFQbHVzRW5nbGlzaF9ITFM/playlist.m3u8"},
      {name: "Channel 20 - Real Madrid TV", url: "https://rmtv.akamaized.net/hls/live/2043154/rmtv-en-web/bitrate_3.m3u8"},
      {name: "Channel 21 - FIFA Club World Cup 1", url: "https://d3o3cim6uzorb4.cloudfront.net/out/v1/f683685242b549f48ea8a5171e3e993a/index.m3u8"},
      {name: "Channel 22 - FIFA Club World Cup 2", url: "https://rgelive.akamaized.net/hls/live/2043151/radiolive/playlistBU_1_.m3u8"},
      {name: "Channel 23 - Jungle Book", url: "https://cc-4bhi5osabejc9.akamaized.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-4bhi5osabejc9/junglebook.m3u8"},
      {name: "Channel 24 - Star Jalsha", url: "https://smart.bengaldigital.live/Star-jalsha/tracks-v1a1/mono.ts.m3u8"},
      {name: "Channel 25 - Gazi TV", url: "https://app24.jagobd.com.bd/c3VydmVyX8RpbEU9Mi8xNy8yMFDDEHGcfRgzQ6NTAgdEoaeFzbF92YWxIZTO0U0ezN1IzMyfvcEdsEfeDeKiNkVN3PTOmdFsaWRtaW51aiPhnPTI2/gazibdz.stream/tracks-v1a1/mono.ts.m3u8"},
      {name: "Channel 26 - Al Jazeera", url: "https://live-hls-web-aje.getaj.net/AJE/01.m3u8?@amarnettv.live"}
    ];

    const video = document.getElementById("player"),
          list = document.getElementById("channelList"),
          overlay = document.getElementById("channelNumberOverlay"),
          errorBox = document.getElementById("errorBox"),
          networkErrorBox = document.getElementById("networkErrorBox"),
          staticNoise = document.getElementById("staticNoise"),
          noiseSound = document.getElementById("noiseSound"),
          playButton = document.getElementById("playButton"),
          greetingScreen = document.getElementById("greetingScreen"),
          typingSound = document.getElementById("typingSound"),
          loadingScreen = document.getElementById("loadingScreen"),
          loadingLogo = document.getElementById("loadingLogo"),
          greetingText = document.getElementById("greetingText"),
          channelLoader = document.getElementById("channelLoader"),
          qualitySelector = document.getElementById("qualitySelector"),
          qualitySelect = document.getElementById("qualitySelect");
    let currentIndex = 0, playingIndex = 0, hls, shakaPlayer, listVisible = false, qualitySelectorVisible = false, overlayTimeout, numberInput = "", numberTimeout, listTimeout, qualityTimeout, hasManuallyPlayed = false, errorTimeout, lastChannelChange = 0;

    function typeText(element, text, duration) {
      console.log("Starting JavaScript typing animation");
      element.textContent = "";
      element.style.width = "auto";
      element.style.animation = "none";
      const chars = text.split("");
      const charTime = duration / chars.length;
      let i = 0;
      typingSound.load();
      typingSound.play().catch(err => console.error("Typing sound play error:", err.message));
      function addChar() {
        if (i < chars.length) {
          element.textContent += chars[i];
          i++;
          setTimeout(addChar, charTime);
        } else {
          console.log("JavaScript typing animation completed");
          typingSound.pause();
          typingSound.currentTime = 0;
          console.log("Typing sound stopped");
        }
      }
      addChar();
    }

    async function checkChannelAvailability(url, channelName) {
      console.log(`Checking availability for ${channelName}: ${url}`);
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 3000);
      try {
        const response = await fetch(url, {
          method: 'HEAD',
          signal: controller.signal,
          headers: { 'Range': 'bytes=0-1023' }
        });
        clearTimeout(timeoutId);
        if (response.ok) {
          console.log(`Channel ${channelName} is available (status: ${response.status})`);
          return true;
        } else {
          console.error(`Channel ${channelName} is not available (status: ${response.status})`);
          return false;
        }
      } catch (err) {
        clearTimeout(timeoutId);
        console.error(`Error checking availability for ${channelName}:`, err.message);
        return false;
      }
    }

    function initializeApp() {
      console.log("Initializing app...");
      const ua = navigator.userAgent,
            isSmartTV = /TV|BRAVIA|AFT|SmartTV|Tizen|Web0S|NetCast|AppleTV/i.test(ua);
      console.log("User Agent:", ua, "Is Smart TV:", isSmartTV);
      if (!isSmartTV) {
        console.log("Non-Smart TV detected, showing incompatible message");
        document.getElementById("incompatibleBox").style.display = "block";
        document.getElementById("container").style.display = "none";
        document.getElementById("azinLogo").style.display = "none";
        document.getElementById("greetingScreen").style.display = "none";
        document.getElementById("loadingScreen").style.display = "none";
        channelLoader.style.display = "none";
        qualitySelector.style.display = "none";
        return;
      }
      console.log("Creating 50 particles for loading animation");
      for (let i = 0; i < 50; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = `${Math.random() * 100}vw`;
        p.style.top = `${Math.random() * 100}vh`;
        p.style.animationDelay = `${Math.random() * 4}s`;
        loadingScreen.appendChild(p);
      }
      let logoLoaded = false;
      loadingLogo.addEventListener('load', () => {
        console.log("Loading logo loaded successfully");
        logoLoaded = true;
      });

      window.addEventListener('DOMContentLoaded', () => {
        const loadingLogo = document.getElementById('loadingLogo');
        setTimeout(() => {
          loadingLogo.src = "https://i.postimg.cc/yW4t2K7P/file-0000000095f461f68b9b01fc40148050-1.png";
        }, 1000);
      });

      function checkInternet() {
        if (!navigator.onLine) {
          console.log("No internet connection detected");
          document.getElementById("loadingScreen").style.display = "flex";
          document.getElementById("loadingScreen").classList.remove("hidden");
          document.getElementById("networkErrorBox").style.display = "block";
          document.getElementById("container").style.display = "none";
          document.getElementById("azinLogo").style.display = "none";
          document.getElementById("greetingScreen").style.display = "none";
          channelLoader.style.display = "none";
          qualitySelector.style.display = "none";
          setTimeout(checkInternet, 2000);
        } else {
          console.log("Internet connection detected");
          document.getElementById("networkErrorBox").style.display = "none";
          proceedWithApp();
        }
      }

      function proceedWithApp() {
        function waitForLogo() {
          if (logoLoaded) {
            console.log("Showing loading screen");
            setTimeout(() => {
              console.log("Hiding loading screen");
              loadingScreen.classList.add('hidden');
              setTimeout(() => {
                loadingScreen.style.display = 'none';
                console.log("Showing greeting screen");
                greetingScreen.style.display = 'flex';
                greetingScreen.classList.remove('hidden');
                greetingScreen.classList.add('visible');
                const greetingMessage = "Assalamualaikum, Welcome to our App";
                typeText(greetingText, greetingMessage, 4000);
                setTimeout(() => {
                  console.log("Hiding greeting screen");
                  greetingScreen.classList.remove('visible');
                  greetingScreen.classList.add('hidden');
                  setTimeout(() => {
                    greetingScreen.style.display = 'none';
                    console.log("Showing main app");
                    document.getElementById("container").style.display = 'block';
                    document.getElementById("azinLogo").style.display = 'block';
                    if (typeof Hls === 'undefined' && typeof shaka === 'undefined') {
                      console.error("Streaming libraries failed to load");
                      showErrorVisual();
                    } else {
                      console.log("Streaming libraries loaded successfully");
                      loadChannel(0, false);
                      showPlayButton();
                    }
                  }, 1000);
                }, 4000);
              }, 1000);
            }, 3000);
          } else {
            setTimeout(waitForLogo, 100);
          }
        }
        waitForLogo();
      }
      checkInternet();
      window.addEventListener('online', () => {
        console.log("Internet connection restored");
        document.getElementById("networkErrorBox").style.display = "none";
        document.getElementById("loadingScreen").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("loadingScreen").style.display = "none";
          proceedWithApp();
        }, 1000);
      });
      window.addEventListener('offline', () => {
        console.log("Internet connection lost");
        document.getElementById("loadingScreen").style.display = "flex";
        document.getElementById("loadingScreen").classList.remove("hidden");
        document.getElementById("networkErrorBox").style.display = "block";
        document.getElementById("container").style.display = "none";
        document.getElementById("azinLogo").style.display = "none";
        document.getElementById("greetingScreen").style.display = "none";
        channelLoader.style.display = "none";
        qualitySelector.style.display = "none";
      });
    }

    function showErrorVisual() {
      console.log("Showing error: This channel is not available for now");
      video.style.display = "none";
      staticNoise.style.opacity = "1";
      staticNoise.style.display = "block";
      errorBox.innerText = "This channel is not available for now";
      errorBox.style.display = "block";
      channelLoader.style.display = "none";
      qualitySelector.style.display = "none";
      qualitySelectorVisible = false;
      function attemptPlayNoiseSound(retries = 3, delay = 500) {
        noiseSound.pause();
        noiseSound.currentTime = 0;
        noiseSound.load();
        noiseSound.play().then(() => {
          console.log("Noise sound playing successfully");
        }).catch(err => {
          console.error("Noise sound play error:", err.message);
          if (retries > 0) {
            console.log(`Retrying noise sound playback, attempts left: ${retries}`);
            setTimeout(() => attemptPlayNoiseSound(retries - 1, delay), delay);
          } else {
            console.error("Failed to play noise sound after retries");
          }
        });
      }
      attemptPlayNoiseSound();
      showPlayButton();
    }

    function hideErrorVisual() {
      console.log("Hiding error visual");
      clearTimeout(errorTimeout);
      video.style.display = "block";
      staticNoise.style.opacity = "0";
      staticNoise.style.display = "none";
      errorBox.style.display = "none";
      noiseSound.pause();
      noiseSound.currentTime = 0;
    }

    function showChannelLoader() {
      console.log("Showing channel loader");
      channelLoader.style.display = "flex";
    }

    function hideChannelLoader() {
      console.log("Hiding channel loader");
      channelLoader.style.display = "none";
    }

    function showQualitySelector() {
      console.log("Showing quality selector");
      qualitySelector.style.display = "block";
      qualitySelectorVisible = true;
      clearTimeout(qualityTimeout);
      qualityTimeout = setTimeout(hideQualitySelector, 7000);
    }

    function hideQualitySelector() {
      console.log("Hiding quality selector");
      qualitySelector.style.display = "none";
      qualitySelectorVisible = false;
    }

    setTimeout(() => {
      channels.forEach((ch, i) => {
        const div = document.createElement("div");
        div.className = "channel";
        div.innerText = ch.name;
        div.onclick = () => loadChannel(i, hasManuallyPlayed);
        list.appendChild(div);
      });
    }, 0);

    function updateUI() {
      document.querySelectorAll('.channel').forEach((el, i) => {
        el.classList.toggle('active', i === currentIndex);
        if (i === currentIndex && listVisible) el.scrollIntoView({ block: "nearest" });
      });
      if (listVisible) {
        clearTimeout(listTimeout);
        listTimeout = setTimeout(hideChannelList, 7000);
      }
    }

    function showOverlay(text) {
      console.log("Showing overlay:", text);
      overlay.innerText = text;
      overlay.style.opacity = '1';
      clearTimeout(overlayTimeout);
      overlayTimeout = setTimeout(() => { overlay.style.opacity = '0'; }, 2000);
    }

    function isM3U8(url) {
      return url.endsWith(".m3u8");
    }

    function isMPD(url) {
      return url.endsWith(".mpd");
    }

    function showPlayButton() {
      const isPlaying = !video.paused && !video.ended;
      const isBuffering = video.readyState < video.HAVE_FUTURE_DATA;
      console.log("Showing play button, isPlaying:", isPlaying, "isBuffering:", isBuffering, "currentIndex:", currentIndex);
      if (currentIndex === 0 || !isBuffering) {
        playButton.style.display = 'flex';
        playButton.classList.toggle('playing', isPlaying);
        playButton.classList.remove('fade-out');
        if (isPlaying) {
          setTimeout(() => {
            playButton.classList.add('fade-out');
          }, 3000);
        }
      } else {
        playButton.style.display = 'none';
      }
    }

    qualitySelect.addEventListener('change', () => {
      if (hls) {
        const selectedValue = qualitySelect.value;
        if (selectedValue === 'auto') {
          hls.autoLevelEnabled = true;
          console.log('Switched to auto quality');
        } else {
          const level = parseInt(selectedValue, 10);
          if (!isNaN(level)) {
            hls.autoLevelEnabled = false;
            hls.currentLevel = level;
            console.log(`Switched to manual quality level ${level}`);
          }
        }
        clearTimeout(qualityTimeout);
        qualityTimeout = setTimeout(hideQualitySelector, 7000);
      }
    });

    async function loadVideo(url, autoPlay, channelName) {
      console.log(`Loading video for ${channelName}, URL: ${url}, autoPlay: ${autoPlay}`);
      qualitySelector.style.display = 'none';
      qualitySelectorVisible = false;
      clearTimeout(errorTimeout);
      const now = Date.now();
      lastChannelChange = now;

      const isAvailable = await checkChannelAvailability(url, channelName);
      if (!isAvailable) {
        console.error(`Channel ${channelName} is not available, skipping buffering`);
        if (lastChannelChange === now) {
          showErrorVisual();
          showPlayButton();
        }
        return;
      }

      showChannelLoader();
      errorTimeout = setTimeout(() => {
        if (lastChannelChange === now) {
          console.error(`Loading timeout for ${channelName}`);
          hideChannelLoader();
          showErrorVisual();
          showPlayButton();
        }
      }, 10000);

      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (shakaPlayer) {
        await shakaPlayer.destroy();
        shakaPlayer = null;
      }
      if (isM3U8(url)) {
        if (typeof Hls !== 'undefined' && Hls.isSupported()) {
          console.log(`HLS supported, initializing Hls.js for ${channelName}`);
          hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 30,
            liveSyncDurationCount: 3,
            liveMaxLatencyDurationCount: 6,
            maxBufferLength: 15,
            startLevel: -1,
            abrEwmaFastLive: 3.0,
            abrEwmaSlowLive: 8.0,
            xhrSetup: function(xhr) {
              xhr.withCredentials = false;
            }
          });
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log(`HLS manifest parsed for ${channelName}`);
            clearTimeout(errorTimeout);
            hideChannelLoader();
            if (autoPlay && hasManuallyPlayed) {
              video.play().catch(err => {
                console.error(`HLS play error for ${channelName}:`, err);
                if (lastChannelChange === now) {
                  hideChannelLoader();
                  showErrorVisual();
                  showPlayButton();
                }
              });
            } else {
              showPlayButton();
            }
            const nextIndex = (currentIndex + 1) % channels.length;
            if (isM3U8(channels[nextIndex].url)) {
              const prefetchHls = new Hls();
              prefetchHls.loadSource(channels[nextIndex].url);
              console.log(`Preloading manifest for ${channels[nextIndex].name}`);
            }
            while (qualitySelect.options.length > 1) {
              qualitySelect.remove(1);
            }
            if (hls.levels && hls.levels.length > 0) {
              hls.levels.forEach((level, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = `${level.height}p`;
                qualitySelect.appendChild(option);
              });
            }
            qualitySelect.selectedIndex = 0;
          });
          hls.on(Hls.Events.ERROR, (_, data) => {
            console.error(`HLS error for ${channelName}:`, data);
            if (data.fatal && lastChannelChange === now) {
              console.log(`Falling back to native video for ${channelName}`);
              video.src = url;
              video.play().catch(err => {
                console.error(`Native video play error for ${channelName}:`, err);
                if (lastChannelChange === now) {
                  hideChannelLoader();
                  showErrorVisual();
                  showPlayButton();
                }
              });
            }
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          console.log(`HLS not supported by Hls.js, using native video for ${channelName}`);
          video.src = url;
          video.onloadeddata = () => {
            console.log(`Native video data loaded for ${channelName}`);
            clearTimeout(errorTimeout);
            hideChannelLoader();
            if (autoPlay && hasManuallyPlayed) {
              video.play().catch(err => {
                console.error(`Native video play error for ${channelName}:`, err);
                if (lastChannelChange === now) {
                  hideChannelLoader();
                  showErrorVisual();
                  showPlayButton();
                }
              });
            } else {
              showPlayButton();
            }
          };
          video.onerror = () => {
            console.error(`Native video error for ${channelName}`);
            if (lastChannelChange === now) {
              hideChannelLoader();
              showErrorVisual();
              showPlayButton();
            }
          };
        } else {
          console.error(`HLS not supported for ${channelName}`);
          if (lastChannelChange === now) {
            hideChannelLoader();
            showErrorVisual();
            showPlayButton();
          }
        }
      } else if (isMPD(url)) {
        if (typeof shaka !== 'undefined') {
          console.log(`Loading MPEG-DASH for ${channelName}`);
          shakaPlayer = new shaka.Player(video);
          shakaPlayer.configure({
            streaming: {
              bufferingGoal: 15,
              rebufferingGoal: 2,
              bufferBehind: 30,
              lowLatencyMode: true
            }
          });
          try {
            await shakaPlayer.load(url);
            console.log(`MPEG-DASH loaded for ${channelName}`);
            clearTimeout(errorTimeout);
            hideChannelLoader();
            if (autoPlay && hasManuallyPlayed) {
              video.play().catch(err => {
                console.error(`MPEG-DASH play error for ${channelName}:`, err);
                if (lastChannelChange === now) {
                  hideChannelLoader();
                  showErrorVisual();
                  showPlayButton();
                }
              });
            } else {
              showPlayButton();
            }
          } catch (e) {
            console.error(`Error loading MPEG-DASH for ${channelName}:`, e);
            if (lastChannelChange === now) {
              hideChannelLoader();
              showErrorVisual();
              showPlayButton();
            }
          }
        } else {
          console.error(`Shaka Player not available for ${channelName}`);
          if (lastChannelChange === now) {
            hideChannelLoader();
            showErrorVisual();
            showPlayButton();
          }
        }
      } else {
        console.log(`Using direct video source for ${channelName}`);
        video.src = url;
        video.onloadeddata = () => {
          console.log(`Video data loaded for ${channelName}`);
          clearTimeout(errorTimeout);
          hideChannelLoader();
          if (autoPlay && hasManuallyPlayed) {
            video.play().catch(err => {
              console.error(`Direct video play error for ${channelName}:`, err);
              if (lastChannelChange === now) {
                showPlayButton();
              }
            });
          } else {
            showPlayButton();
          }
        };
        video.onerror = () => {
          console.error(`Direct video error for ${channelName}`);
          if (lastChannelChange === now) {
            hideChannelLoader();
            showErrorVisual();
            showPlayButton();
          }
        };
      }
    }

    function loadChannel(index, autoPlay = false) {
      if (!navigator.onLine) {
        console.log("No internet connection, showing network error");
        document.getElementById("loadingScreen").style.display = "flex";
        document.getElementById("loadingScreen").classList.remove("hidden");
        document.getElementById("networkErrorBox").style.display = "block";
        document.getElementById("container").style.display = "none";
        document.getElementById("azinLogo").style.display = "none";
        document.getElementById("greetingScreen").style.display = "none";
        channelLoader.style.display = "none";
        qualitySelector.style.display = "none";
        qualitySelectorVisible = false;
        return;
      }
      console.log(`Loading channel ${index + 1}: ${channels[index].name}, autoPlay: ${autoPlay}`);
      currentIndex = index;
      playingIndex = index;
      hideErrorVisual();
      loadVideo(channels[index].url, autoPlay, channels[index].name);
      video.muted = false;
      updateUI();
      hideChannelList();
      showOverlay(String(index + 1));
      if (index === 0) {
        playButton.style.display = 'flex';
        playButton.classList.remove('playing');
        playButton.classList.remove('fade-out');
      } else {
        showPlayButton();
      }
      hideQualitySelector();
    }

    function showChannelList() {
      console.log("Showing channel list");
      list.style.display = "block";
      listVisible = true;
      updateUI();
      clearTimeout(listTimeout);
      listTimeout = setTimeout(hideChannelList, 7000);
    }

    function hideChannelList() {
      console.log("Hiding channel list");
      list.style.display = "none";
      listVisible = false;
      currentIndex = playingIndex;
      updateUI();
    }

    function changeChannelList() {
      listVisible ? hideChannelList() : showChannelList();
    }

    function changeChannel(direction) {
      currentIndex = direction === "up" ? (currentIndex - 1 + channels.length) % channels.length : (currentIndex + 1) % channels.length;
      console.log(`Changing channel to index ${currentIndex}`);
      listVisible ? updateUI() : loadChannel(currentIndex, hasManuallyPlayed);
    }

    document.addEventListener('keydown', e => {
      const key = e.key, code = e.keyCode;
      console.log(`Key pressed: ${key} (code: ${code})`);

      if (key === "q" || key === "Q" || key === "Info" || code === 73) {
        if (isM3U8(channels[currentIndex].url)) {
          qualitySelectorVisible ? hideQualitySelector() : showQualitySelector();
        }
        e.preventDefault();
        return;
      }

      if (key >= "0" && key <= "9") {
        numberInput += key;
        showOverlay(numberInput);
        clearTimeout(numberTimeout);
        numberTimeout = setTimeout(() => {
          const num = parseInt(numberInput, 10);
          if (num >= 1 && num <= channels.length) loadChannel(num - 1, hasManuallyPlayed);
          numberInput = "";
        }, 2000);
        e.preventDefault();
        return;
      }

      if (["Enter", "OK", "Accept", "SoftRight"].includes(key) || code === 13) {
        if (numberInput.length > 0) {
          console.log("OK pressed, confirming channel number:", numberInput);
          const num = parseInt(numberInput, 10);
          if (num >= 1 && num <= channels.length) {
            loadChannel(num - 1, hasManuallyPlayed);
          }
          numberInput = "";
          clearTimeout(numberTimeout);
          overlay.style.opacity = '0';
          e.preventDefault();
          return;
        }
        if (listVisible) {
          console.log("OK pressed, changing channel to index:", currentIndex);
          loadChannel(currentIndex, hasManuallyPlayed);
          e.preventDefault();
          return;
        }
        if (qualitySelectorVisible) {
          console.log("OK pressed, selecting quality");
          qualitySelect.dispatchEvent(new Event('change'));
          e.preventDefault();
          return;
        }
        if (!listVisible) {
          if (video.paused || video.ended) {
            console.log("OK pressed, playing video");
            hasManuallyPlayed = true;
            video.play().catch(err => {
              console.error("Play error:", err);
              if (lastChannelChange === Date.now()) {
                showErrorVisual();
              }
            });
          } else {
            console.log("OK pressed, pausing video");
            video.pause();
          }
          showPlayButton();
          e.preventDefault();
          return;
        }
      }

      if (["ArrowLeft", "ArrowRight"].includes(key)) {
        changeChannelList();
        e.preventDefault();
        return;
      }

      if (listVisible) {
        if (key === "ArrowUp" || key === "PageUp" || key === "ChannelUp" || code === 33) {
          currentIndex = (currentIndex - 1 + channels.length) % channels.length;
          updateUI();
          e.preventDefault();
          return;
        }
        if (key === "ArrowDown" || key === "PageDown" || key === "ChannelDown" || code === 34) {
          currentIndex = (currentIndex + 1) % channels.length;
          updateUI();
          e.preventDefault();
          return;
        }
      } else {
        if (["ArrowUp", "ChannelUp"].includes(key) || code === 33) {
          changeChannel("down");
          e.preventDefault();
          return;
        }
        if (["ArrowDown", "ChannelDown"].includes(key) || code === 34) {
          changeChannel("up");
          e.preventDefault();
          return;
        }
      }

      if (["MediaPlayPause", " "].includes(key)) {
        if (video.paused) {
          console.log("Attempting to play video via MediaPlayPause");
          hasManuallyPlayed = true;
          video.play().catch(err => {
            console.error("Play error:", err);
            if (lastChannelChange === Date.now()) {
              showErrorVisual();
            }
          });
          showPlayButton();
        } else {
          console.log("Pausing video via MediaPlayPause");
          video.pause();
          showPlayButton();
        }
        e.preventDefault();
      }
    });

    video.addEventListener('playing', () => {
      console.log("Video is playing");
      clearTimeout(errorTimeout);
      hideChannelLoader();
      showPlayButton();
    });
    video.addEventListener('pause', () => {
      console.log("Video paused");
      showPlayButton();
    });
    video.addEventListener('error', () => {
      console.log("Video element error");
      if (lastChannelChange === Date.now()) {
        hideChannelLoader();
        showErrorVisual();
        showPlayButton();
      }
    });
    video.addEventListener('waiting', () => {
      console.log("Video is buffering");
      showChannelLoader();
    });

    shaka.polyfill.installAll();
    if (shaka.Player.isBrowserSupported()) {
      console.log("Shaka Player is supported");
    } else {
      console.error("Shaka Player is not supported");
    }

    initializeApp();
  </script>
</body>
</html>
